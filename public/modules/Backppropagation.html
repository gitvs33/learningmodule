<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Backpropagation Coffee Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent horizontal scroll on small screens */
        }
        .node {
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }
        .item {
            position: absolute;
            transition: all 0.8s ease-in-out;
            padding: 8px;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            z-index: 10;
        }
        .line {
            position: absolute;
            background-color: #4b5563;
            height: 2px;
            transform-origin: 0 0;
            z-index: 1;
        }
        .btn-disabled {
            background-color: #4a5568;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .pulse {
            animation: pulse-animation 1s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(236, 72, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-200 flex flex-col items-center justify-center min-h-screen p-2 sm:p-4">

    <div class="w-full max-w-7xl mx-auto bg-gray-900 rounded-2xl shadow-2xl p-4 sm:p-6 relative">
        <!-- Title -->
        <h1 class="text-2xl md:text-3xl font-bold text-center text-amber-300 mb-2">The Backpropagation Coffee Shop</h1>
        <p class="text-center text-gray-400 mb-4 md:mb-6">Learn how a neural network "learns" by adjusting a coffee recipe.</p>

        <!-- Main Animation Canvas -->
        <div id="canvas" class="relative h-[400px] md:h-[450px] w-full border-2 border-gray-700 rounded-lg bg-gray-800/50 p-2 sm:p-4">
            <!-- Nodes -->
            <div id="beans-node" class="node absolute top-1/4 -translate-y-1/2 left-[5%] w-28 h-24 md:w-36 md:h-24 bg-blue-600 rounded-lg flex flex-col items-center justify-center p-2 shadow-lg z-20">
                <span class="text-3xl md:text-4xl">ü´ò</span>
                <span class="font-bold text-sm">Coffee Beans</span>
                <span id="beans-value" class="text-sm">20g</span>
            </div>
            <div id="sugar-node" class="node absolute top-3/4 -translate-y-1/2 left-[5%] w-28 h-24 md:w-36 md:h-24 bg-blue-600 rounded-lg flex flex-col items-center justify-center p-2 shadow-lg z-20">
                <span class="text-3xl md:text-4xl">üç¨</span>
                <span class="font-bold text-sm">Sugar</span>
                <span id="sugar-value" class="text-sm">15g</span>
            </div>
            <div id="mix-node" class="node absolute top-1/2 -translate-y-1/2 left-1/2 -translate-x-1/2 w-28 h-24 md:w-36 md:h-24 bg-emerald-600 rounded-lg flex flex-col items-center justify-center p-2 shadow-lg z-20">
                <span class="text-3xl md:text-4xl">üßë‚Äçüç≥</span>
                <span class="font-bold text-sm">Mix Recipe</span>
                <span id="mix-value" class="text-xs"></span>
            </div>
            <div id="customer-node" class="node absolute top-1/2 -translate-y-1/2 right-[5%] w-28 h-24 md:w-36 md:h-24 bg-purple-600 rounded-lg flex flex-col items-center justify-center p-2 shadow-lg z-20">
                <span class="text-3xl md:text-4xl">üòã</span>
                <span class="font-bold text-sm">Taste Score</span>
                <span id="customer-value" class="text-xl md:text-2xl font-bold">? / 10</span>
            </div>
        </div>
        
        <!-- Controls and Explanation -->
        <div class="mt-6 flex flex-col md:flex-row gap-6">
            <div class="w-full md:w-1/3">
                <h2 class="text-lg md:text-xl font-bold text-amber-400 mb-3">Controls</h2>
                <div class="space-y-3">
                    <button id="forward-btn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 md:py-3 px-4 rounded-lg transition-colors duration-300 text-base md:text-lg">
                        1. Make Coffee
                    </button>
                    <button id="backward-btn" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 md:py-3 px-4 rounded-lg transition-colors duration-300 text-base md:text-lg btn-disabled">
                        2. Get Feedback
                    </button>
                     <button id="reset-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">
                        Start a New Order
                    </button>
                </div>
            </div>
            <div class="w-full md:w-2/3 bg-gray-800 p-4 rounded-lg">
                <h2 class="text-lg md:text-xl font-bold text-amber-400 mb-3">What's Happening?</h2>
                <div id="explanation-text" class="text-gray-300 space-y-2 text-sm">
                    <p>Our goal is to get a perfect 10/10 taste score. Let's start with our initial recipe and see what the customer thinks!</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const canvas = document.getElementById('canvas');
        const nodes = {
            beans: document.getElementById('beans-node'),
            sugar: document.getElementById('sugar-node'),
            mix: document.getElementById('mix-node'),
            customer: document.getElementById('customer-node')
        };
        const values = {
            beans: document.getElementById('beans-value'),
            sugar: document.getElementById('sugar-value'),
            mix: document.getElementById('mix-value'),
            customer: document.getElementById('customer-value')
        };
        const buttons = {
            forward: document.getElementById('forward-btn'),
            backward: document.getElementById('backward-btn'),
            reset: document.getElementById('reset-btn')
        };
        const explanationText = document.getElementById('explanation-text');

        // --- State ---
        let recipe = { beans: 20, sugar: 15 };
        const idealTaste = 10;
        let currentTaste = 0;
        const learningRate = 0.1; // Crucial ML concept: how big of a step to take.

        function drawLines() {
            // Clear existing lines
            document.querySelectorAll('.line').forEach(line => line.remove());

            // Helper function to create a single line
            const createLine = (fromNode, toNode) => {
                const fromRect = fromNode.getBoundingClientRect();
                const toRect = toNode.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();

                const fromX = fromRect.left + fromRect.width / 2 - canvasRect.left;
                const fromY = fromRect.top + fromRect.height / 2 - canvasRect.top;
                const toX = toRect.left + toRect.width / 2 - canvasRect.left;
                const toY = toRect.top + toRect.height / 2 - canvasRect.top;

                const distance = Math.sqrt((toX - fromX)**2 + (toY - fromY)**2);
                const angle = Math.atan2(toY - fromY, toX - fromX) * 180 / Math.PI;

                const line = document.createElement('div');
                line.classList.add('line');
                line.style.width = `${distance}px`;
                line.style.left = `${fromX}px`;
                line.style.top = `${fromY}px`;
                line.style.transform = `rotate(${angle}deg)`;
                canvas.appendChild(line);
            };
            
            // Draw all necessary lines
            createLine(nodes.beans, nodes.mix);
            createLine(nodes.sugar, nodes.mix);
            createLine(nodes.mix, nodes.customer);
        }

        function animateItem(emoji, fromNode, toNode, onComplete, colorClass = 'bg-cyan-500') {
            const item = document.createElement('div');
            item.innerHTML = emoji;
            item.classList.add('item', colorClass);
            canvas.appendChild(item);

            const fromRect = fromNode.getBoundingClientRect();
            const toRect = toNode.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();

            item.style.left = `${fromRect.left + fromRect.width / 2 - canvasRect.left - 18}px`;
            item.style.top = `${fromRect.top + fromRect.height / 2 - canvasRect.top - 18}px`;

            setTimeout(() => {
                item.style.left = `${toRect.left + toRect.width / 2 - canvasRect.left - 18}px`;
                item.style.top = `${toRect.top + toRect.height / 2 - canvasRect.top - 18}px`;
            }, 50);

            setTimeout(() => {
                if (item.parentElement) {
                    canvas.removeChild(item);
                }
                onComplete();
            }, 850);
        }
        
        function updateExplanation(html) {
            explanationText.innerHTML = html;
        }

        function runForwardPass() {
            buttons.forward.classList.add('btn-disabled');
            updateExplanation(`<p>1. We're sending the ingredients (our inputs) to be mixed...</p>`);
            
            animateItem('ü´ò', nodes.beans, nodes.mix, () => {}, 'bg-cyan-500');
            animateItem('üç¨', nodes.sugar, nodes.mix, () => {
                nodes.mix.classList.add('pulse');
                updateExplanation(`<p>2. The recipe is mixed. Our simple formula is: <br><strong class='text-amber-300'>(Beans * 0.2) + (Sugar * 0.4)</strong></p>`);
                
                setTimeout(() => {
                    nodes.mix.classList.remove('pulse');
                    currentTaste = (recipe.beans * 0.2) + (recipe.sugar * 0.4);
                    values.mix.textContent = `Strength: ${currentTaste.toFixed(1)}`;
                    
                    animateItem('‚òï', nodes.mix, nodes.customer, () => {
                        nodes.customer.classList.add('pulse');
                        updateExplanation(`<p>3. The customer tastes the coffee... Let's see the score!</p>`);
                        
                        setTimeout(() => {
                            nodes.customer.classList.remove('pulse');
                            values.customer.innerHTML = `<span class="text-xl md:text-3xl">${currentTaste.toFixed(1)}</span> / 10`;
                            
                            if (Math.abs(currentTaste - idealTaste) < 0.1) {
                                updateExplanation(`<p class="text-green-400 font-bold text-lg">A perfect 10/10! The recipe is optimized! üéâ</p>`);
                            } else {
                                updateExplanation(`<p>The score is ${currentTaste.toFixed(1)}/10. Not quite right. Time to get some feedback to adjust the recipe!</p>`);
                                buttons.backward.classList.remove('btn-disabled');
                            }
                        }, 1000);
                    }, 'bg-amber-500');
                }, 1000);
            }, 'bg-cyan-500');
        }
        
        function runBackwardPass() {
            buttons.backward.classList.add('btn-disabled');
            const error = idealTaste - currentTaste;
            updateExplanation(`<p>1. The customer wanted a '10' but got a '${currentTaste.toFixed(1)}'. The "error" is <strong class='text-pink-400'>${error.toFixed(1)}</strong>. This feedback is sent back.</p>`);
            
            animateItem('üìù', nodes.customer, nodes.mix, () => {
                nodes.mix.classList.add('pulse');
                
                // This is the core of backpropagation: calculating gradients
                const sugarGradient = 0.4 * error;
                const beansGradient = 0.2 * error;

                updateExplanation(`<p>2. We calculate how much each ingredient affected the error (the 'gradient'). Then we take a small step (the 'learning rate') to adjust.</p>
                <ul class='list-disc list-inside'>
                    <li>Sugar's influence: <strong class='text-pink-400'>${sugarGradient.toFixed(2)}</strong></li>
                    <li>Beans' influence: <strong class='text-pink-400'>${beansGradient.toFixed(2)}</strong></li>
                </ul>`);

                setTimeout(() => {
                    nodes.mix.classList.remove('pulse');
                    
                    animateItem('üìà', nodes.mix, nodes.sugar, () => {
                        nodes.sugar.classList.add('pulse');
                        recipe.sugar += sugarGradient * learningRate; // Update recipe using gradient and learning rate
                        values.sugar.textContent = `${recipe.sugar.toFixed(1)}g`;
                        setTimeout(() => nodes.sugar.classList.remove('pulse'), 1000);
                    }, 'bg-pink-500');
                    
                    animateItem('üìâ', nodes.mix, nodes.beans, () => {
                        nodes.beans.classList.add('pulse');
                        recipe.beans += beansGradient * learningRate; // Update recipe
                        values.beans.textContent = `${recipe.beans.toFixed(1)}g`;
                        setTimeout(() => nodes.beans.classList.remove('pulse'), 1000);
                    }, 'bg-pink-500');

                    setTimeout(() => {
                         updateExplanation(`<p>3. The recipe has been adjusted! The amounts were changed according to their 'influence' and the learning rate. Try making coffee again!</p>`);
                         buttons.forward.classList.remove('btn-disabled');
                         values.customer.innerHTML = `? / 10`;
                         values.mix.textContent = ``;
                    }, 1000);

                }, 1500);

            }, 'bg-pink-500');
        }

        function reset() {
            recipe = { beans: 20, sugar: 15 };
            currentTaste = 0;
            
            values.beans.textContent = `${recipe.beans}g`;
            values.sugar.textContent = `${recipe.sugar}g`;
            values.mix.textContent = '';
            values.customer.innerHTML = `? / 10`;
            
            buttons.forward.classList.remove('btn-disabled');
            buttons.backward.classList.add('btn-disabled');
            
            updateExplanation(`<p>Our goal is to get a perfect 10/10 taste score. Let's start with our initial recipe and see what the customer thinks!</p>`);
        }

        function init() {
            drawLines();
            buttons.forward.addEventListener('click', runForwardPass);
            buttons.backward.addEventListener('click', runBackwardPass);
            buttons.reset.addEventListener('click', reset);

            // Redraw lines on resize to keep it responsive
            new ResizeObserver(drawLines).observe(canvas);
        }

        // Use a small timeout with window.onload to ensure all assets and CSS are fully rendered
        // before we calculate element positions. This prevents timing issues.
        window.onload = () => {
            setTimeout(init, 100);
        };
    </script>
</body>
</html>
